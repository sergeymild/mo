{"code":"import { action, noop, die, isFunction, isStringish, storeAnnotation, createFlowAnnotation } from \"../internal\";\r\nexport const FLOW = \"flow\";\r\nlet generatorId = 0;\r\nexport function FlowCancellationError() {\r\n    this.message = \"FLOW_CANCELLED\";\r\n}\r\nFlowCancellationError.prototype = Object.create(Error.prototype);\r\nexport function isFlowCancellationError(error) {\r\n    return error instanceof FlowCancellationError;\r\n}\r\nconst flowAnnotation = createFlowAnnotation(\"flow\");\r\nexport const flow = Object.assign(function flow(arg1, arg2) {\r\n    // @flow\r\n    if (isStringish(arg2)) {\r\n        return storeAnnotation(arg1, arg2, flowAnnotation);\r\n    }\r\n    // flow(fn)\r\n    if (__DEV__ && arguments.length !== 1)\r\n        die(`Flow expects single argument with generator function`);\r\n    const generator = arg1;\r\n    const name = generator.name || \"<unnamed flow>\";\r\n    // Implementation based on https://github.com/tj/co/blob/master/index.js\r\n    const res = function () {\r\n        const ctx = this;\r\n        const args = arguments;\r\n        const runId = ++generatorId;\r\n        const gen = action(`${name} - runid: ${runId} - init`, generator).apply(ctx, args);\r\n        let rejector;\r\n        let pendingPromise = undefined;\r\n        const promise = new Promise(function (resolve, reject) {\r\n            let stepId = 0;\r\n            rejector = reject;\r\n            function onFulfilled(res) {\r\n                pendingPromise = undefined;\r\n                let ret;\r\n                try {\r\n                    ret = action(`${name} - runid: ${runId} - yield ${stepId++}`, gen.next).call(gen, res);\r\n                }\r\n                catch (e) {\r\n                    return reject(e);\r\n                }\r\n                next(ret);\r\n            }\r\n            function onRejected(err) {\r\n                pendingPromise = undefined;\r\n                let ret;\r\n                try {\r\n                    ret = action(`${name} - runid: ${runId} - yield ${stepId++}`, gen.throw).call(gen, err);\r\n                }\r\n                catch (e) {\r\n                    return reject(e);\r\n                }\r\n                next(ret);\r\n            }\r\n            function next(ret) {\r\n                if (isFunction(ret?.then)) {\r\n                    // an async iterator\r\n                    ret.then(next, reject);\r\n                    return;\r\n                }\r\n                if (ret.done)\r\n                    return resolve(ret.value);\r\n                pendingPromise = Promise.resolve(ret.value);\r\n                return pendingPromise.then(onFulfilled, onRejected);\r\n            }\r\n            onFulfilled(undefined); // kick off the process\r\n        });\r\n        promise.cancel = action(`${name} - runid: ${runId} - cancel`, function () {\r\n            try {\r\n                if (pendingPromise)\r\n                    cancelPromise(pendingPromise);\r\n                // Finally block can return (or yield) stuff..\r\n                const res = gen.return(undefined);\r\n                // eat anything that promise would do, it's cancelled!\r\n                const yieldedPromise = Promise.resolve(res.value);\r\n                yieldedPromise.then(noop, noop);\r\n                cancelPromise(yieldedPromise); // maybe it can be cancelled :)\r\n                // reject our original promise\r\n                rejector(new FlowCancellationError());\r\n            }\r\n            catch (e) {\r\n                rejector(e); // there could be a throwing finally block\r\n            }\r\n        });\r\n        return promise;\r\n    };\r\n    res.isMobXFlow = true;\r\n    return res;\r\n}, flowAnnotation);\r\nfunction cancelPromise(promise) {\r\n    if (isFunction(promise.cancel))\r\n        promise.cancel();\r\n}\r\nexport function flowResult(result) {\r\n    return result; // just tricking TypeScript :)\r\n}\r\nexport function isFlow(fn) {\r\n    return fn?.isMobXFlow === true;\r\n}\r\n//# sourceMappingURL=flow.js.map","references":["/Users/sergeigolishnikov/development/web/mobx/packages/mobx/src/internal.ts"],"map":"{\"version\":3,\"file\":\"flow.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../src/api/flow.ts\"],\"names\":[],\"mappings\":\"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\"}"}
